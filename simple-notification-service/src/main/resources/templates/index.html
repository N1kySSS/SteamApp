<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>WebSocket demo</title>-->
<!--    <style>-->
<!--        body { font-family: sans-serif; padding: 20px; }-->
<!--        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }-->
<!--        .log { color: gray; font-size: 0.8em; }-->
<!--        .msg { color: blue; font-weight: bold; }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--<h2>Live Notifications</h2>-->
<!--<div id="status">Status: Disconnected</div>-->
<!--<div id="messages"></div>-->

<!--<script>-->
<!--    const statusDiv = document.getElementById('status');-->
<!--    const messagesDiv = document.getElementById('messages');-->

<!--    let socket = null;-->
<!--    let reconnectAttempts = 0;-->
<!--    let reconnectTimer = null;-->
<!--    let pingInterval = null;-->

<!--    const userId = crypto.randomUUID();-->
<!--    const MAX_RECONNECT_DELAY = 30000; // макс. 30 сек между попытками-->

<!--    function connect() {-->
<!--        // Защита от повторного вызова-->
<!--        if (socket && socket.readyState === WebSocket.CONNECTING) {-->
<!--            return;-->
<!--        }-->

<!--        // Очищаем предыдущий таймер-->
<!--        if (reconnectTimer) {-->
<!--            clearTimeout(reconnectTimer);-->
<!--            reconnectTimer = null;-->
<!--        }-->

<!--        // ws:// для http, wss:// для https (продакшен)-->
<!--        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';-->
<!--        socket = new WebSocket(`${protocol}//localhost:8080/ws/notifications?userId=${userId}`);-->

<!--        socket.onopen = function() {-->
<!--            reconnectAttempts = 0; // сброс счетчика при успешном подключении-->
<!--            statusDiv.textContent = 'Status: Connected';-->
<!--            statusDiv.style.color = 'green';-->
<!--            log('Соединение установлено');-->

<!--            if (pingInterval) clearInterval(pingInterval);-->

<!--            pingInterval = setInterval(() => {-->
<!--                if (socket && socket.readyState === WebSocket.OPEN) {-->
<!--                    socket.send("PING");-->
<!--                    log('Отправлен: PING');-->
<!--                }-->
<!--            }, 10000);-->
<!--        };-->

<!--        socket.onmessage = function(event) {-->
<!--            log('Получено: ' + event.data, 'msg');-->
<!--        };-->

<!--        socket.onclose = function(event) {-->
<!--            statusDiv.textContent = 'Status: Disconnected';-->
<!--            statusDiv.style.color = 'red';-->

<!--            if (pingInterval) {-->
<!--                clearInterval(pingInterval);-->
<!--                pingInterval = null;-->
<!--            }-->

<!--            const reason = event.wasClean-->
<!--                ? `закрыто чисто, код=${event.code}`-->
<!--                : 'обрыв соединения';-->
<!--            log(`Отключение: ${reason}`);-->

<!--            scheduleReconnect();-->
<!--        };-->

<!--        socket.onerror = function() {-->
<!--            // WebSocket error event не содержит деталей (по соображениям безопасности)-->
<!--            log('Ошибка соединения');-->
<!--        };-->
<!--    }-->

<!--    function scheduleReconnect() {-->
<!--        // Exponential backoff: 1s, 2s, 4s, 8s... до MAX_RECONNECT_DELAY-->
<!--        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), MAX_RECONNECT_DELAY);-->
<!--        reconnectAttempts++;-->

<!--        log(`Переподключение через ${delay/1000} сек (попытка ${reconnectAttempts})...`);-->
<!--        reconnectTimer = setTimeout(connect, delay);-->
<!--    }-->

<!--    function log(text, type = 'log') {-->
<!--        const div = document.createElement('div');-->
<!--        div.className = type;-->
<!--        div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;-->
<!--        messagesDiv.appendChild(div);-->
<!--        messagesDiv.scrollTop = messagesDiv.scrollHeight;-->
<!--    }-->

<!--    // Запуск-->
<!--    connect();-->
<!--</script>-->
<!--</body>-->
<!--</html>-->

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Система уведомлений</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        #status { text-align: center; margin-bottom: 20px; font-weight: bold; color: #dc3545; }
        .notification { padding: 15px; margin-bottom: 10px; border-left: 5px solid; border-radius: 4px; animation: slideIn 0.5s ease-out; }
        .result { background-color: #d4edda; border-color: #28a745; color: #155724; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
<div class="container">
    <h2>Центр уведомлений</h2>
    <div id="status">Отключено</div>
    <div id="notifications-area"></div>
</div>

<script>
    const statusDiv = document.getElementById('status');
    const area = document.getElementById('notifications-area');
    let socket;

    function connect() {
        // Подключение к нашему новому сервису
        socket = new WebSocket('ws://localhost:25501/ws/notifications');

        socket.onopen = () => {
            statusDiv.innerText = 'Подключено к системе событий';
            statusDiv.style.color = '#28a745';
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("Получено событие:", data);

            if (data.type === 'DISCOUNT_ADDED') {
                showNotification(data);
            }
        };

        socket.onclose = () => {
            statusDiv.innerText = 'Соединение разорвано. Переподключение...';
            statusDiv.style.color = '#dc3545';
            setTimeout(connect, 3000);
        };
    }

    function showNotification(data) {
        const div = document.createElement('div');
        div.className = `notification result`;
        div.innerHTML = `
            <strong>Game ID: ${data.gameId}</strong><br>
            Скидка рассчитана: ${data.discount}%<br>
            Финальная цена: ${data.finalPrice}₽
        `;
        area.prepend(div);
    }

    connect();
</script>
</body>
</html>
